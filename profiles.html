<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubble - Profiles</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        /* Compact hover card - appears over the map next to the pin */
        .hover-profile-panel {
            position: absolute;
            z-index: 20;
            display: none;
            width: 200px;
            padding: 0.6rem 0.75rem;
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.97);
            box-shadow: 0 8px 24px rgba(19, 41, 75, 0.18), 0 0 0 1px rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            pointer-events: auto;
        }
        .hover-profile-panel .hover-profile-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }
        .hover-profile-panel .hover-profile-img {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(75, 156, 211, 0.25);
        }
        .hover-profile-panel .hover-profile-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .hover-profile-panel .hover-profile-name { font-size: 0.95rem; font-weight: 800; color: #13294B; margin: 0; line-height: 1.2; }
        .hover-profile-panel .hover-profile-meta { font-size: 0.72rem; color: #6b8dae; margin: 0.2rem 0 0.5rem; }
        .hover-profile-panel .hover-profile-actions { display: flex; gap: 0.4rem; flex-wrap: wrap; }
        .hover-profile-panel .hover-profile-actions a { text-decoration: none; font-size: 0.75rem; padding: 0.35rem 0.6rem; }
    </style>
</head>

<body>
    <div class="app-wrap">
        <nav class="top-nav fade-in">
            <a href="my-profile.html" class="profile-btn" id="profileNavBtn">
                <span id="navUserName">Anushka</span>
                <div class="profile-btn-avatar" id="navUserAvatar">A</div>
            </a>
        </nav>

        <!-- New Location Search Bar -->
        <div class="search-container fade-in" style="animation-delay: 0.1s;">
            <div class="glass-search-box" id="locationSearchWrap">
                <span class="search-icon">üîç</span>
                <input type="text" id="locationSearch" placeholder="Search city or state (e.g. Chapel Hill, NC)" autocomplete="off">
                <button id="searchBtn">Find Bubbles</button>
            </div>
            <div id="locationDropdown" class="location-dropdown" style="display: none;"></div>
        </div>

        <!-- Friends in your bubble: title + bubble + hover profile (hidden until search) -->
        <div id="friendsSection" style="display: none;">
            <h2 id="friendsTitle" class="feed-title fade-in">Friends in your bubble</h2>
            <div id="placeBubbleContainer" class="place-bubble-container">
                <div class="massive-bubble">
                    <h2 id="placeBubbleTitle" class="place-title">The Quad</h2>
                    <div id="bubblePins" class="bubble-pins-wrapper"></div>
                </div>
                <!-- Compact card appears over map next to pin on hover -->
                <div id="hoverProfilePanel" class="hover-profile-panel"></div>
            </div>
        </div>

        <script src="app.js"></script>
        <script>
            document.body.classList.add('bubble-done');

            // Update Nav from LocalStorage
            const storedProfile = localStorage.getItem('bubble_user_profile');
            if (storedProfile) {
                const profile = JSON.parse(storedProfile);
                if (profile.name) {
                    document.getElementById('navUserName').textContent = profile.name.split(' ')[0];
                    document.getElementById('navUserAvatar').textContent = profile.name.charAt(0).toUpperCase();
                }
            }

            // People shown as pins in the bubble ‚Äî scattered layout (keys match user-profile.html)
            const BUBBLE_PEOPLE = [
                { key: 'isabella', name: 'Isabella', age: 21, gender: 'Woman', school: 'UNC Chapel Hill', img: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&q=80&w=100&h=100', bio: 'Coffee addict, reading in the quad, always exploring vintage shops. Easy-going, always looking for a study buddy or someone to grab food with!', top: '32%', left: '18%', large: false },
                { key: 'liam', name: 'Liam', age: 22, gender: 'Man', school: 'UNC Chapel Hill', img: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&q=80&w=100&h=100', bio: 'Hackathons, climbing gym, and building pointless apps. Let\'s code. Always down for a quick hike or a deep dive into some obscure tech.', top: '68%', left: '82%', large: false },
                { key: 'sophia', name: 'Sophia', age: 20, gender: 'Woman', school: 'UNC Chapel Hill', img: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&q=80&w=100&h=100', bio: 'Model building at 3 AM. Looking for study buddies who bring snacks. Architecture is life; I make time for photography and pottery.', top: '85%', left: '38%', large: false },
                { key: 'marcus', name: 'Marcus', age: 21, gender: 'Man', school: 'UNC Chapel Hill', img: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&q=80&w=100&h=100', bio: 'Pre-med, coffee runs at 2 AM. Love hiking and board game nights. Always looking for someone to study with at the library.', top: '52%', left: '72%', large: false },
                { key: 'zoe', name: 'Zoe', age: 19, gender: 'Woman', school: 'UNC Chapel Hill', img: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&q=80&w=100&h=100', bio: 'Film and media studies. Into indie music and thrift shopping. Down for movie marathons and deep conversations.', top: '78%', left: '22%', large: false },
                { key: 'jake', name: 'Jake', age: 23, gender: 'Man', school: 'UNC Chapel Hill', img: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?auto=format&fit=crop&q=80&w=100&h=100', bio: 'Grad student in economics. Runner and trivia nerd. Looking for running buddies and people who like food trucks.', top: '42%', left: '48%', large: false },
                { key: 'emma', name: 'Emma', age: 20, gender: 'Woman', school: 'UNC Chapel Hill', img: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?auto=format&fit=crop&q=80&w=100&h=100', bio: 'English major, book club regular. Love cozy cafes and weekend brunch. Always up for a new recommendation.', top: '28%', left: '58%', large: false },
                { key: 'noah', name: 'Noah', age: 22, gender: 'Man', school: 'UNC Chapel Hill', img: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&q=80&w=100&h=100', bio: 'CS and music. I play guitar and build side projects. Looking for jam buddies and hackathon teammates.', top: '62%', left: '35%', large: false },
                { key: 'ava', name: 'Ava', age: 21, gender: 'Woman', school: 'UNC Chapel Hill', img: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?auto=format&fit=crop&q=80&w=100&h=100', bio: 'Psychology and art. Love painting and people-watching at the quad. Down for museum trips and late-night talks.', top: '38%', left: '85%', large: false }
            ];

            function briefBio(text, maxLen) {
                if (!text) return '';
                maxLen = maxLen || 100;
                if (text.length <= maxLen) return text;
                return text.slice(0, maxLen).trim().replace(/\s+\S*$/, '') + '‚Ä¶';
            }

            const searchInput = document.getElementById('locationSearch');
            const searchBtn = document.getElementById('searchBtn');
            const friendsSection = document.getElementById('friendsSection');
            const placeBubbleTitle = document.getElementById('placeBubbleTitle');
            const bubblePins = document.getElementById('bubblePins');
            const hoverProfilePanel = document.getElementById('hoverProfilePanel');

            function renderPins() {
                var html = '';
                BUBBLE_PEOPLE.forEach(function (p, i) {
                    var cls = p.large ? 'profile-pin pin-large' : 'profile-pin';
                    var delay = (i * 0.08 + 0.1).toFixed(2);
                    html += '<div class="' + cls + ' bubble-pin" data-user-key="' + p.key + '" style="top:' + p.top + ';left:' + p.left + ';animation-delay:' + delay + 's"><img src="' + p.img + '" alt="' + p.name + '"></div>';
                });
                bubblePins.innerHTML = html;

                var hidePanelTimer = null;
                function scheduleHidePanel() {
                    if (hidePanelTimer) clearTimeout(hidePanelTimer);
                    hidePanelTimer = setTimeout(function () {
                        hoverProfilePanel.style.display = 'none';
                        hoverProfilePanel.innerHTML = '';
                        hidePanelTimer = null;
                    }, 200);
                }
                hoverProfilePanel.addEventListener('mouseenter', function () {
                    if (hidePanelTimer) { clearTimeout(hidePanelTimer); hidePanelTimer = null; }
                });
                hoverProfilePanel.addEventListener('mouseleave', function () {
                    scheduleHidePanel();
                });

                var container = document.getElementById('placeBubbleContainer');
                var gap = 10;

                bubblePins.querySelectorAll('.bubble-pin').forEach(function (pin) {
                    var key = pin.getAttribute('data-user-key');
                    var person = BUBBLE_PEOPLE.find(function (p) { return p.key === key; });
                    if (!person) return;

                    pin.addEventListener('mouseenter', function () {
                        if (hidePanelTimer) { clearTimeout(hidePanelTimer); hidePanelTimer = null; }
                        var meta = [person.age, person.gender, person.school].filter(Boolean).join(' ¬∑ ');
                        hoverProfilePanel.innerHTML =
                            '<div class="hover-profile-row">' +
                            '<div class="hover-profile-img"><img src="' + person.img.replace('w=100', 'w=200') + '" alt="' + person.name + '"></div>' +
                            '<div class="hover-profile-name">' + person.name + '</div>' +
                            '</div>' +
                            (meta ? '<div class="hover-profile-meta">' + meta + '</div>' : '') +
                            '<div class="hover-profile-actions">' +
                            '<a href="user-profile.html?user=' + person.key + '" class="btn-add btn-connect">View</a><a href="chat.html?user=' + person.key + '" class="btn-add btn-connect">Chat</a>' +
                            '</div>';
                        hoverProfilePanel.style.display = 'block';

                        var pinRect = pin.getBoundingClientRect();
                        var contRect = container.getBoundingClientRect();
                        var cardW = 200;
                        var placeRight = pinRect.right - contRect.left + gap;
                        var placeLeft = pinRect.left - contRect.left - cardW - gap;
                        if (placeRight + cardW <= contRect.width && placeRight >= 0) {
                            hoverProfilePanel.style.left = placeRight + 'px';
                            hoverProfilePanel.style.right = 'auto';
                        } else {
                            hoverProfilePanel.style.left = Math.max(8, placeLeft) + 'px';
                            hoverProfilePanel.style.right = 'auto';
                        }
                        var cardH = hoverProfilePanel.offsetHeight;
                        var top = pinRect.top - contRect.top + (pinRect.height / 2) - (cardH / 2);
                        top = Math.max(8, Math.min(top, contRect.height - cardH - 8));
                        hoverProfilePanel.style.top = top + 'px';
                    });

                    pin.addEventListener('mouseleave', function () {
                        scheduleHidePanel();
                    });
                });
            }

            function executeSearch() {
                var query = searchInput.value.trim();
                if (!query) return;

                placeBubbleTitle.textContent = query;
                renderPins();

                friendsSection.style.display = 'block';
                setTimeout(function () {
                    document.getElementById('placeBubbleContainer').classList.add('visible');
                }, 50);
            }

            searchBtn.addEventListener('click', executeSearch);
            searchInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') executeSearch();
            });

            // --- Location autocomplete: real cities/states, standardized (City, State) ---
            const LOCATION_OPTIONS = [
                'Chapel Hill, NC', 'Raleigh, NC', 'Durham, NC', 'Charlotte, NC', 'Greensboro, NC',
                'Wilmington, NC', 'Asheville, NC', 'Cary, NC', 'Winston-Salem, NC', 'Fayetteville, NC',
                'New York, NY', 'Brooklyn, NY', 'Buffalo, NY', 'Rochester, NY',
                'Los Angeles, CA', 'San Francisco, CA', 'San Diego, CA', 'San Jose, CA', 'Oakland, CA',
                'Chicago, IL', 'Boston, MA', 'Cambridge, MA', 'Philadelphia, PA', 'Pittsburgh, PA',
                'Houston, TX', 'Austin, TX', 'Dallas, TX', 'San Antonio, TX',
                'Seattle, WA', 'Portland, OR', 'Denver, CO', 'Boulder, CO',
                'Atlanta, GA', 'Miami, FL', 'Orlando, FL', 'Tampa, FL',
                'Washington, DC', 'Baltimore, MD', 'Ann Arbor, MI', 'Detroit, MI',
                'Minneapolis, MN', 'Madison, WI', 'Nashville, TN', 'Memphis, TN',
                'New Orleans, LA', 'Phoenix, AZ', 'Tucson, AZ', 'Albuquerque, NM',
                'Columbus, OH', 'Cleveland, OH', 'Cincinnati, OH', 'Indianapolis, IN',
                'Charleston, SC', 'Columbia, SC', 'Richmond, VA', 'Virginia Beach, VA'
            ];

            const locationDropdown = document.getElementById('locationDropdown');
            const searchWrap = document.getElementById('locationSearchWrap');

            function capitalizeMatch(text, query) {
                if (!query) return text;
                const i = text.toLowerCase().indexOf(query.toLowerCase());
                if (i < 0) return text;
                return text.slice(0, i) + text.slice(i, i + query.length) + text.slice(i + query.length);
            }

            function showLocationDropdown() {
                const q = searchInput.value.trim().toLowerCase();
                if (!q) { locationDropdown.style.display = 'none'; return; }
                const filtered = LOCATION_OPTIONS.filter(function (loc) {
                    return loc.toLowerCase().indexOf(q) >= 0;
                }).slice(0, 8);
                if (filtered.length === 0) { locationDropdown.style.display = 'none'; return; }
                locationDropdown.innerHTML = filtered.map(function (loc) {
                    const idx = loc.toLowerCase().indexOf(q);
                    const before = loc.slice(0, idx);
                    const match = loc.slice(idx, idx + q.length);
                    const after = loc.slice(idx + q.length);
                    return '<div class="location-dropdown-item" data-value="' + loc.replace(/"/g, '&quot;') + '">' + before + '<strong>' + match + '</strong>' + after + '</div>';
                }).join('');
                const rect = searchWrap.getBoundingClientRect();
                locationDropdown.style.top = (rect.bottom + 6) + 'px';
                locationDropdown.style.left = rect.left + 'px';
                locationDropdown.style.width = rect.width + 'px';
                locationDropdown.style.display = 'block';
            }

            function hideLocationDropdown() {
                setTimeout(function () { locationDropdown.style.display = 'none'; }, 150);
            }

            searchInput.addEventListener('input', showLocationDropdown);
            searchInput.addEventListener('focus', function () { if (searchInput.value.trim()) showLocationDropdown(); });
            searchInput.addEventListener('blur', hideLocationDropdown);

            locationDropdown.addEventListener('click', function (e) {
                const item = e.target.closest('.location-dropdown-item');
                if (item) {
                    searchInput.value = item.getAttribute('data-value');
                    locationDropdown.style.display = 'none';
                }
            });

        </script>
</body>

</html>