<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubble - Welcome</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        /* Adjust popup for larger form */
        .popup-box {
            aspect-ratio: auto;
            border-radius: 2rem;
            padding: 3rem;
            max-width: 500px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .step-container {
            display: none;
            animation: slideUp 0.4s ease-out forwards;
        }

        .step-container.active {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.5);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.8);
            color: #000;
        }

        .question-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #000;
            line-height: 1.3;
        }

        .question-desc {
            color: #666;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #7BAFD4;
            transition: width 0.3s ease;
        }
    </style>
</head>

<body>
    <div class="app-wrap">
        <div class="hero">
            <h1 class="logo logo-done">Bubble</h1>
        </div>
    </div>

    <div id="floatBubbles" class="float-bubbles" style="display: none;"></div>
    <!-- School dropdown rendered here on body to escape popup overflow:hidden -->
    <div id="schoolDropdown" class="school-dropdown" style="display:none;"></div>

    <!-- Onboarding Popup -->
    <div class="popup-overlay fade-in">
        <div class="popup-box">
            <div class="text-left" style="width: 100%;">

                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 20%;"></div>
                </div>

                <form id="onboardingForm" class="login-form" novalidate>
                    <!-- Step 1: Name -->
                    <div class="step-container active" id="ob-step-1">
                        <h2 class="question-title">What's your full name?</h2>
                        <p class="question-desc">So your matches know who you are.</p>
                        <input type="text" id="nameInput" class="bubble-input" placeholder="e.g. Jane Doe" required>
                        <div class="btn-group">
                            <button type="button" class="btn-add next-btn" style="flex: 1;">Next</button>
                        </div>
                    </div>

                    <!-- Step 2: Age -->
                    <div class="step-container" id="ob-step-2">
                        <h2 class="question-title">How old are you?</h2>
                        <p class="question-desc">You must be at least 18 to use Bubble.</p>
                        <input type="number" id="ageInput" class="bubble-input" min="18" max="150" placeholder="e.g. 21"
                            required>
                        <div class="btn-group">
                            <button type="button" class="btn-add btn-secondary back-btn">Back</button>
                            <button type="button" class="btn-add next-btn" style="flex: 1;">Next</button>
                        </div>
                    </div>

                    <!-- Step 3: Gender -->
                    <div class="step-container" id="ob-step-3">
                        <h2 class="question-title">How do you identify?</h2>
                        <p class="question-desc">This helps us organize your discover feed.</p>
                        <select id="genderInput" class="bubble-input" required style="appearance: none;">
                            <option value="" disabled selected>Select gender</option>
                            <option value="Woman">Woman</option>
                            <option value="Man">Man</option>
                            <option value="Non-binary">Non-binary</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select>
                        <div class="btn-group">
                            <button type="button" class="btn-add btn-secondary back-btn">Back</button>
                            <button type="button" class="btn-add next-btn" style="flex: 1;">Next</button>
                        </div>
                    </div>

                    <!-- Step 4: Secondary Email -->
                    <div class="step-container" id="ob-step-4">
                        <h2 class="question-title">Any secondary email?</h2>
                        <p class="question-desc">For when your unc email expires.</p>
                        <input type="email" id="secondaryEmailInput" class="bubble-input"
                            placeholder="e.g. personal@gmail.com" required>
                        <div class="btn-group">
                            <button type="button" class="btn-add btn-secondary back-btn">Back</button>
                            <button type="button" class="btn-add next-btn" style="flex: 1;">Next</button>
                        </div>
                    </div>

                    <!-- Step 5: Phone Number -->
                    <div class="step-container" id="ob-step-5">
                        <h2 class="question-title">What's your phone number?</h2>
                        <p class="question-desc">We use SMS to verify real students.</p>
                        <input type="tel" id="phoneInput" class="bubble-input" placeholder="(555) 555-5555" required>
                        <div class="btn-group">
                            <button type="button" class="btn-add btn-secondary back-btn">Back</button>
                            <button type="button" class="btn-add next-btn" style="flex: 1;">Next</button>
                        </div>
                    </div>

                    <!-- Step 6: School -->
                    <div class="step-container" id="ob-step-6">
                        <h2 class="question-title">What school do you attend?</h2>
                        <p class="question-desc">Help us find students on your campus.</p>
                        <!-- Custom school search dropdown -->
                        <div class="school-search-wrap" style="position: relative; width: 100%;">
                            <input type="text" id="schoolSearchInput" class="bubble-input" autocomplete="off"
                                placeholder="Search for your college..." style="width: 100%; box-sizing: border-box;">
                            <!-- Hidden input holds the confirmed selected value -->
                            <input type="text" id="schoolInput" style="display:none;">
                            <!-- Dropdown is rendered on body to escape overflow:hidden -->
                        </div>
                        <p id="schoolError" class="error-msg hidden" style="margin-top:0.4rem;">Please select a school
                            from the list.</p>
                        <div class="btn-group">
                            <button type="button" class="btn-add btn-secondary back-btn">Back</button>
                            <button type="button" id="schoolNextBtn" class="btn-add" style="flex: 1;">Next</button>
                        </div>
                    </div>

                    <!-- Step 7: Major -->
                    <div class="step-container" id="ob-step-7">
                        <h2 class="question-title">What's your major?</h2>
                        <p class="question-desc">Find peers with similar academic interests.</p>
                        <input type="text" id="majorInput" class="bubble-input" placeholder="e.g. Computer Science"
                            required>
                        <div class="btn-group">
                            <button type="button" class="btn-add btn-secondary back-btn">Back</button>
                            <button type="button" class="btn-add next-btn" style="flex: 1;">Next</button>
                        </div>
                    </div>

                    <!-- Step 8: Bio -->
                    <div class="step-container" id="ob-step-8">
                        <h2 class="question-title">Tell us about yourself</h2>
                        <p class="question-desc">Write a short bio for your profile card.</p>
                        <textarea id="bioInput" class="bubble-input"
                            style="height: 100px; resize: none; width: 100%; border-radius: 1rem; padding: 1rem;"
                            placeholder="Coffee addict, hackathon lover..."></textarea>
                        <div class="btn-group" style="margin-top: 1rem;">
                            <button type="button" class="btn-add btn-secondary back-btn">Back</button>
                            <button type="submit" class="btn-add" style="flex: 1;">Complete Profile</button>
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        document.body.classList.add('bubble-done');

        // Typeform logic
        var currentStep = 1;
        var totalSteps = 8;
        var progressFill = document.getElementById('progressFill');

        function showStep(step) {
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            document.getElementById('ob-step-' + step).classList.add('active');
            progressFill.style.width = ((step / totalSteps) * 100) + '%';

            // Focus first input
            setTimeout(() => {
                var input = document.getElementById('ob-step-' + step).querySelector('input, select');
                if (input) input.focus();
            }, 100);
        }

        // Initial setup
        showStep(currentStep);

        // --- Custom School Search Dropdown ---
        var FALLBACK_SCHOOLS = [
            "Auburn University", "Arizona State University", "Boston College", "Boston University",
            "Brigham Young University", "Brown University", "California Institute of Technology",
            "Carnegie Mellon University", "Case Western Reserve University", "Clemson University",
            "Columbia University", "Cornell University", "Dartmouth College", "Duke University",
            "Emory University", "Florida State University", "Fordham University", "Georgetown University",
            "Georgia Institute of Technology", "Harvard University", "Indiana University",
            "Johns Hopkins University", "Lehigh University", "Louisiana State University",
            "Michigan State University", "MIT", "New York University", "Northeastern University",
            "Northwestern University", "Notre Dame", "Ohio State University", "Penn State",
            "Princeton University", "Purdue University", "Rice University", "Rutgers University",
            "Stanford University", "Syracuse University", "Temple University", "Texas A&M University",
            "Tulane University", "UC Berkeley", "UC Davis", "UC Irvine", "UC Los Angeles",
            "UC San Diego", "UC Santa Barbara", "University of Alabama", "University of Arizona",
            "University of Chicago", "University of Colorado Boulder", "University of Connecticut",
            "University of Florida", "University of Georgia", "University of Houston",
            "University of Illinois Urbana-Champaign", "University of Iowa",
            "University of Kansas", "University of Kentucky", "University of Maryland",
            "University of Massachusetts Amherst", "University of Miami",
            "University of Michigan", "University of Minnesota", "University of Missouri",
            "University of Nebraska", "University of North Carolina at Chapel Hill",
            "University of Oregon", "University of Pennsylvania", "University of Pittsburgh",
            "University of Rochester", "University of South Carolina", "University of Southern California",
            "University of Tennessee", "University of Texas at Austin", "University of Utah",
            "University of Virginia", "University of Washington", "University of Wisconsin-Madison",
            "Vanderbilt University", "Villanova University", "Virginia Tech", "Wake Forest University",
            "Washington University in St. Louis", "William & Mary", "Yale University"
        ];
        var allSchools = FALLBACK_SCHOOLS.slice().sort();

        var schoolSearchInput = document.getElementById('schoolSearchInput');
        var schoolInput = document.getElementById('schoolInput');
        var schoolDropdown = document.getElementById('schoolDropdown');
        var schoolError = document.getElementById('schoolError');
        var schoolNextBtn = document.getElementById('schoolNextBtn');

        // Try to augment with API data
        fetch('http://universities.hipolabs.com/search?country=United+States')
            .then(r => r.json())
            .then(data => {
                var apiSchools = [...new Set(data.map(item => item.name))];
                allSchools = [...new Set([...FALLBACK_SCHOOLS, ...apiSchools])].sort();
            })
            .catch(() => { /* keep fallback */ });

        function positionDropdown() {
            var rect = schoolSearchInput.getBoundingClientRect();
            schoolDropdown.style.top = (rect.bottom + 6) + 'px';
            schoolDropdown.style.left = rect.left + 'px';
            schoolDropdown.style.width = rect.width + 'px';
        }

        function renderDropdown(query) {
            schoolDropdown.innerHTML = '';
            if (!query || query.length < 1) { schoolDropdown.style.display = 'none'; return; }
            if (allSchools.length === 0) {
                var loading = document.createElement('div');
                loading.className = 'school-dropdown-item';
                loading.textContent = 'Loading schools...';
                loading.style.color = '#999';
                schoolDropdown.appendChild(loading);
                positionDropdown();
                schoolDropdown.style.display = 'block';
                return;
            }
            var filtered = allSchools.filter(s => s.toLowerCase().includes(query.toLowerCase())).slice(0, 8);
            if (filtered.length === 0) { schoolDropdown.style.display = 'none'; return; }
            filtered.forEach(function (school) {
                var item = document.createElement('div');
                item.className = 'school-dropdown-item';
                var idx = school.toLowerCase().indexOf(query.toLowerCase());
                item.innerHTML = school.slice(0, idx)
                    + '<strong>' + school.slice(idx, idx + query.length) + '</strong>'
                    + school.slice(idx + query.length);
                item.addEventListener('mousedown', function (e) {
                    e.preventDefault();
                    schoolSearchInput.value = school;
                    schoolInput.value = school;
                    schoolDropdown.style.display = 'none';
                    schoolError.classList.add('hidden');
                });
                schoolDropdown.appendChild(item);
            });
            positionDropdown();
            schoolDropdown.style.display = 'block';
        }

        if (schoolSearchInput) {
            schoolSearchInput.addEventListener('input', function () {
                schoolInput.value = '';
                renderDropdown(this.value.trim());
            });
            schoolSearchInput.addEventListener('blur', function () {
                setTimeout(() => { schoolDropdown.style.display = 'none'; }, 150);
            });
            schoolSearchInput.addEventListener('focus', function () {
                if (this.value.trim()) renderDropdown(this.value.trim());
            });
        }

        // Custom Next button for school step
        if (schoolNextBtn) {
            schoolNextBtn.addEventListener('click', function () {
                if (!schoolInput.value.trim()) {
                    schoolError.classList.remove('hidden');
                    schoolSearchInput.focus();
                    return;
                }
                schoolError.classList.add('hidden');
                if (currentStep < totalSteps) {
                    currentStep++;
                    showStep(currentStep);
                }
            });
        }

        document.querySelectorAll('.next-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                // Native HTML5 validation
                var currentInput = document.getElementById('ob-step-' + currentStep).querySelector('input, select');
                if (currentInput && !currentInput.reportValidity()) return;

                if (currentStep < totalSteps) {
                    currentStep++;
                    showStep(currentStep);
                }
            });
        });

        document.querySelectorAll('.back-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                if (currentStep > 1) {
                    currentStep--;
                    showStep(currentStep);
                }
            });
        });

        // Handle enter key to go next
        document.getElementById('onboardingForm').addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                var currentInput = document.getElementById('ob-step-' + currentStep).querySelector('input, select');
                if (currentStep === 6) return; // School step has its own button handler
                if (currentInput && !currentInput.value.trim()) { currentInput.focus(); return; }

                if (currentStep < totalSteps) {
                    currentStep++;
                    showStep(currentStep);
                } else if (currentStep === totalSteps) {
                    document.getElementById('onboardingForm').dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                }
            }
        });

        document.getElementById('onboardingForm').addEventListener('submit', function (e) {
            e.preventDefault();
            var bio = document.getElementById('bioInput').value.trim();
            if (!bio) {
                document.getElementById('bioInput').focus();
                return;
            }
            // Save profile data
            const profileData = {
                name: document.getElementById('nameInput').value,
                age: document.getElementById('ageInput').value,
                gender: document.getElementById('genderInput').value,
                secondaryEmail: document.getElementById('secondaryEmailInput').value,
                phone: document.getElementById('phoneInput').value,
                school: document.getElementById('schoolInput').value,
                major: document.getElementById('majorInput').value,
                bio: bio
            };
            localStorage.setItem('bubble_user_profile', JSON.stringify(profileData));
            window.location.href = 'profiles.html';
        });
    </script>
</body>

</html>