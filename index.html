<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#22d3ee" />
  <title>Bubble</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="float-bubbles" id="floatBubbles" aria-hidden="true"></div>
  <div class="hero">
    <a href="#main" class="bubble-wrap" id="bubbleWrap" aria-label="Go to main page">
      <h1 class="logo" aria-label="Bubble"><span id="logoText"></span><span class="logo-cursor" id="logoCursor"></span>
      </h1>
    </a>
  </div>
  <main id="main" class="main">
  </main>

  <div id="loginPopup" class="popup-overlay hidden">
    <div class="popup-box">
      <div id="step-1">
        <h2>Log in or<br>create an account</h2>
        <form id="emailForm" class="login-form mt-3" novalidate>
          <div class="input-group">
            <input type="email" id="emailInput" placeholder="University Email (.edu)" class="bubble-input" required>
            <p id="emailError" class="error-msg hidden">Please enter a valid .edu email address.</p>
          </div>
          <button type="submit" class="btn-add">Continue</button>
        </form>
      </div>

      <div id="step-2" class="hidden text-left">
        <button type="button" class="close-btn" id="backToLoginBtn"
          aria-label="Back to log in or create account">X</button>
        <h2>Welcome back!</h2>
        <p class="subtitle">Enter your password to log in.</p>

        <form id="passwordForm" class="login-form">
          <div class="input-group">
            <label class="font-bold">Email Address</label>
            <div class="email-edit-group">
              <input type="email" id="disabledEmail" class="bubble-input disabled-input" readonly>
              <button type="button" id="editBtn" class="edit-btn">Edit</button>
            </div>
          </div>

          <div class="input-group mt-3">
            <label class="font-bold">Password</label>
            <div class="password-group">
              <input type="password" id="passwordInput" class="bubble-input" required>
              <button type="button" class="toggle-password" id="togglePasswordBtn">
                <svg viewBox="0 0 24 24" fill="none" class="eye-icon">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" />
                  <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
              </button>
            </div>
          </div>

          <p id="loginError" class="error-msg hidden"
            style="margin-top: 0.5rem; font-size: 0.9rem; font-weight: 400; text-align: left;">Incorrect password.
            Please try again.</p>

          <a href="#" class="forgot-pwd">Forgot your password?</a>
          <button type="submit" class="btn-add">Log in</button>
        </form>

        <p class="footer-terms">By continuing, you agree to the updated <a href="#">Terms of Service</a>, and <a
            href="#">Privacy Policy</a>.</p>
      </div>

      <!-- Step 3: Create Account -->
      <div id="step-3" class="hidden text-left">
        <button type="button" class="close-btn" id="backToLoginBtnSignup"
          aria-label="Back to log in or create account">X</button>
        <h2>Create account</h2>
        <p class="subtitle">Set a password to get started.</p>

        <form id="signupForm" class="login-form">
          <div class="input-group">
            <label class="font-bold">Email Address</label>
            <div class="email-edit-group">
              <input type="email" id="signupEmail" class="bubble-input disabled-input" readonly>
              <button type="button" id="editBtnSignup" class="edit-btn">Edit</button>
            </div>
          </div>

          <div class="input-group mt-3">
            <label class="font-bold">Password</label>
            <div class="password-group">
              <input type="password" id="signupPasswordInput" class="bubble-input" required>
              <button type="button" class="toggle-password" id="togglePasswordBtnSignup">
                <svg viewBox="0 0 24 24" fill="none" class="eye-icon">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" />
                  <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
              </button>
            </div>
          </div>

          <p id="signupError" class="error-msg hidden"
            style="margin-top: 0.5rem; font-size: 0.8rem; font-weight: 400; text-align: left; color: #ff4d4d;">
            Password must contain at least 8 characters, a lowercase letter, and a number.
          </p>

          <button type="submit" class="btn-add">Create account</button>
        </form>

        <p class="footer-terms">By continuing, you agree to the updated <a href="#">Terms of Service</a>, and <a
            href="#">Privacy Policy</a>.</p>
      </div>
    </div>
  </div>

  <script>
    (function () {
      var logoEl = document.getElementById('logoText');
      var logoTitle = document.querySelector('.logo');
      var bubbleWrap = document.getElementById('bubbleWrap');
      var floatContainer = document.getElementById('floatBubbles');
      var word = 'Bubble';
      var i = 0;
      function type() {
        if (logoEl && logoTitle && i < word.length) {
          logoEl.textContent += word[i];
          i++;
          setTimeout(type, 90 + Math.random() * 80);
        } else if (logoTitle) {
          logoTitle.classList.add('logo-done');
          if (bubbleWrap) bubbleWrap.classList.add('reveal');
          document.body.classList.add('bubble-done');
        }
      }

      // Start bubbles rising immediately as page loads
      if (floatContainer) {
        for (var b = 0; b < 18; b++) {
          var el = document.createElement('div');
          el.className = 'float-bubble';
          el.style.left = Math.random() * 100 + '%';
          el.style.width = el.style.height = (12 + Math.random() * 24) + 'px';
          // Make initial ones start rising immediately or very soon
          el.style.animationDelay = (Math.random() * 2) + 's';
          el.style.animationDuration = (2.5 + Math.random() * 2) + 's';
          floatContainer.appendChild(el);
        }
      }
      // Start typing slightly after bubbles begin rising
      setTimeout(type, 400);

      // Handle main bubble click
      bubbleWrap.addEventListener('click', function (e) {
        e.preventDefault();

        // Prevent further clicks
        bubbleWrap.style.pointerEvents = 'none';

        // Add popping animation to main bubble
        bubbleWrap.classList.add('popping-main');

        // Create spray effect
        var hero = document.querySelector('.hero');
        if (hero) {
          for (var s = 0; s < 25; s++) {
            var drop = document.createElement('div');
            drop.className = 'spray-drop';
            var angle = Math.random() * Math.PI * 2;
            var velocity = 150 + Math.random() * 250;
            drop.style.setProperty('--tx', (Math.cos(angle) * velocity) + 'px');
            drop.style.setProperty('--ty', (Math.sin(angle) * velocity) + 'px');
            hero.appendChild(drop);
          }
        }

        // Wait for bubble to completely pop (pop animation is 450ms)
        setTimeout(function () {
          var hero = document.querySelector('.hero');
          if (hero) hero.style.display = 'none'; // Hide the popped bubble completely 

          if (floatContainer) floatContainer.classList.add('fade-out');

          // Only after the bubble is gone and background is fading do we show the popup
          setTimeout(function () {
            if (floatContainer) floatContainer.style.display = 'none';
            var loginPopup = document.getElementById('loginPopup');
            if (loginPopup) loginPopup.classList.remove('hidden');
          }, 600); // Wait for fade out
        }, 900); // Significant delay to clearly show it popped empty space
      });

      // Handle form validation & Step Transition
      var emailForm = document.getElementById('emailForm');
      var emailInput = document.getElementById('emailInput');
      var emailError = document.getElementById('emailError');

      var step1 = document.getElementById('step-1');
      var step2 = document.getElementById('step-2');
      var disabledEmail = document.getElementById('disabledEmail');
      var editBtn = document.getElementById('editBtn');
      var backToLoginBtn = document.getElementById('backToLoginBtn');

      function isAnushkaEmail(email) {
        return email === 'anushkag@unc.edu' || email === 'anushkag@gmail.com' || email.indexOf('anushkag@gmail') === 0;
      }

      if (emailForm) {
        emailForm.addEventListener('submit', function (e) {
          e.preventDefault();
          var email = emailInput.value.trim().toLowerCase();
          var allowed = email.endsWith('.edu') || isAnushkaEmail(email);
          if (!allowed) {
            emailError.classList.remove('hidden');
            emailInput.classList.add('input-error');
          } else {
            emailError.classList.add('hidden');
            emailInput.classList.remove('input-error');
            if (isAnushkaEmail(email)) {
              // Known user (Anushka), show password step
              var popupBox = document.querySelector('.popup-box');
              if (popupBox) popupBox.classList.add('popup-step-2');
              step1.classList.add('hidden');
              step2.classList.remove('hidden');
              disabledEmail.value = email;
              localStorage.setItem('bubble_login_email', email);
            } else {
              // New user, go to create account step â€” profile will use their onboarding input later
              var popupBox = document.querySelector('.popup-box');
              if (popupBox) popupBox.classList.add('popup-step-2');
              step1.classList.add('hidden');
              var step3 = document.getElementById('step-3');
              if (step3) step3.classList.remove('hidden');
              var signupEmail = document.getElementById('signupEmail');
              if (signupEmail) signupEmail.value = email;
              localStorage.setItem('bubble_login_email', email);
            }
          }
        });
      }

      if (editBtn) {
        editBtn.addEventListener('click', function (e) {
          e.preventDefault();
          var popupBox = document.querySelector('.popup-box');
          if (popupBox) popupBox.classList.remove('popup-step-2');
          step2.classList.add('hidden');
          step1.classList.remove('hidden');
        });
      }

      if (backToLoginBtn) {
        backToLoginBtn.addEventListener('click', function (e) {
          e.preventDefault();
          var popupBox = document.querySelector('.popup-box');
          if (popupBox) popupBox.classList.remove('popup-step-2');
          step2.classList.add('hidden');
          step1.classList.remove('hidden');
        });
      }

      var togglePasswordBtn = document.getElementById('togglePasswordBtn');
      var passwordInput = document.getElementById('passwordInput');
      if (togglePasswordBtn && passwordInput) {
        togglePasswordBtn.addEventListener('click', function (e) {
          e.preventDefault();
          if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
          } else {
            passwordInput.type = 'password';
          }
        });
      }

      var passwordForm = document.getElementById('passwordForm');
      var loginError = document.getElementById('loginError');

      if (passwordForm) {
        passwordForm.addEventListener('submit', function (e) {
          e.preventDefault();
          var email = disabledEmail.value.toLowerCase();
          var pwd = passwordInput.value;

          if (isAnushkaEmail(email)) {
            if (pwd === "Nothing23") {
              // Set Anushka's predefined profile so My Profile shows her info
              var anushkaProfile = {
                name: 'Anushka Ganesh',
                age: 21,
                gender: 'Woman',
                secondaryEmail: 'anu@gmail.com',
                school: 'Chapel Hill',
                bio: 'coffee'
              };
              localStorage.setItem('bubble_user_profile', JSON.stringify(anushkaProfile));
              window.location.href = 'profiles.html';
            } else {
              loginError.classList.remove('hidden');
              passwordInput.classList.add('input-error');
            }
          } else {
            window.location.href = 'onboarding.html';
          }
        });
      }

      if (passwordInput) {
        passwordInput.addEventListener('input', function () {
          loginError.classList.add('hidden');
          passwordInput.classList.remove('input-error');
        });
      }

      // signup logic
      var signupForm = document.getElementById('signupForm');
      var signupPasswordInput = document.getElementById('signupPasswordInput');
      var signupError = document.getElementById('signupError');

      if (signupForm) {
        signupForm.addEventListener('submit', function (e) {
          e.preventDefault();
          var pwd = signupPasswordInput.value;

          // Validation: 8 chars, lowercase, number
          var hasLower = /[a-z]/.test(pwd);
          var hasNum = /[0-9]/.test(pwd);
          var hasLength = pwd.length >= 8;

          if (hasLower && hasNum && hasLength) {
            window.location.href = 'onboarding.html';
          } else {
            signupError.classList.remove('hidden');
            signupPasswordInput.classList.add('input-error');
          }
        });

        if (signupPasswordInput) {
          signupPasswordInput.addEventListener('input', function () {
            signupError.classList.add('hidden');
            signupPasswordInput.classList.remove('input-error');
          });
        }
      }

      // Back buttons for signup
      var backToLoginBtnSignup = document.getElementById('backToLoginBtnSignup');
      var editBtnSignup = document.getElementById('editBtnSignup');
      var step3 = document.getElementById('step-3');

      if (backToLoginBtnSignup) {
        backToLoginBtnSignup.addEventListener('click', function (e) {
          e.preventDefault();
          var popupBox = document.querySelector('.popup-box');
          if (popupBox) popupBox.classList.remove('popup-step-2');
          step3.classList.add('hidden');
          step1.classList.remove('hidden');
        });
      }

      if (editBtnSignup) {
        editBtnSignup.addEventListener('click', function (e) {
          e.preventDefault();
          var popupBox = document.querySelector('.popup-box');
          if (popupBox) popupBox.classList.remove('popup-step-2');
          step3.classList.add('hidden');
          step1.classList.remove('hidden');
        });
      }

      var togglePasswordBtnSignup = document.getElementById('togglePasswordBtnSignup');
      if (togglePasswordBtnSignup && signupPasswordInput) {
        togglePasswordBtnSignup.addEventListener('click', function (e) {
          e.preventDefault();
          if (signupPasswordInput.type === 'password') {
            signupPasswordInput.type = 'text';
          } else {
            signupPasswordInput.type = 'password';
          }
        });
      }

    })();
  </script>
  <script src="app.js"></script>
</body>

</html>